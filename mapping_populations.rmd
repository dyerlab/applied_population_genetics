# Mapping Populations

Almost every data set we will work on has a spatial context.  Until relatively recently, this was larely ignored and at most given as a 2-dimensional projection of sampling locations on a black and white map in our manuscirpts.  Here we explore methodologies to provide more intuitive approaches for plotting the spatial location of our sampling sites.

## Proceedure

First, we need to load in the proper libraries. Each of the libraries are needed for:

 - **gstudio** - Contains the *A. attenuatus* data set and there are built-in routines that allow you to plot populations in various formats or export the data in a format for ploting in other systems (e.g., GoogleEarth, ArcGIS, etc).
 - **ggmap** - Allows the plotting of tiles from a googleMap.
 - **leaflet** - Loads in the javascript leaflet library and allows the interactive visualization.



## Plotting Population Locations

We will start by loading in the default dataset for `gstudio` and using methods in that package for producting spatial plots.

```{r,message=FALSE,warning=FALSE}
# load in the libraries and grab the data
require(gstudio)
require(ggmap)
data(arapat)

# pull out the coordinates - Population is the default stratums
coords <- strata_coordinates(arapat)
coords$Stratum <- as.character( coords$Stratum )
coords[1:5,]

# make a map (grabs from google) and plot it
map <- population_map(coords)
ggmap( map ) + geom_point( aes(x=Longitude,y=Latitude),data=coords)
```

We can extend this basic plotting by adding text to the plots indicating the population names (here I offset the coordinates by 0.1 & 0.12 degreesâ€”a cheap trick but it works pretty well here).

```{r,warning=FALSE}
p <- ggmap( map ) + geom_point( aes(x=Longitude,y=Latitude),data=coords) 
p + geom_text( aes(x=Longitude+0.1,y=Latitude+0.12,label=Stratum), data=coords)
```

We can also plot some genetically-relevant materials such as allele frequencies

```{r}
# Break out allele frequencies for LTRS by population 
f <- frequencies(arapat,loci="LTRS",stratum="Population")

# lets only use the allele 01 
f <- f[ f$Allele=="01",]

# here are what the data look like
f[1:10,]
```

and then use those frequencies as image size.

```{r warning=FALSE, message=FALSE}
# merget the frequencies into the coordinate data.frame
coords <- merge( coords, f[,c(1,4)])
ggmap( map ) + geom_point( aes(x=Longitude,y=Latitude,size=Frequency),data=coords)
```

or for observed effective allele size

```{r warning=FALSE, message=FALSE}
# grab effect for LTRS locus
ae <- genetic_diversity(arapat, stratum = "Population", mode="Ae")
ae <- ae[ ae$Locus=="LTRS",]

# merge in the data
coords <- merge( coords, ae[,c(1,3)])
ggmap( map ) + geom_point( aes(x=Longitude,y=Latitude,size=Ae),data=coords)
```




## Dynamic maps

We can also produce dynamic maps for viewing in html output (like ebooks or webpages).  Here I produce a leaflet map and then add markers on to the file using coordinates and put the clicked popup as the population name.  This is an *interactive* map, you can zoom in, etc.

```{r,message=FALSE,warning=FALSE}
require(leaflet)
require(magrittr)
leaflet( data=coords ) %>% 
  addTiles() %>% 
  addMarkers( ~Longitude, ~Latitude, popup=~Stratum )
```

You can change the underlying base map by passing on other Tiles to the construction.  A list of available tile providers can be found [here](http://leaflet-extras.github.io/leaflet-providers/preview/index.html).

```{r}
leaflet( data=coords ) %>% 
  addProviderTiles("MapQuestOpen.Aerial") %>% 
  addMarkers( ~Longitude, ~Latitude, popup=~Stratum)
```

Or you can add custom images for the map relative to some meaningful information.

```{r}
coords$Size <- log(coords$Ae) * 10 + 1
leaflet( data=coords ) %>%  
  addTiles() %>% 
  addCircleMarkers( ~Longitude, ~Latitude, 
                    popup=~Stratum, 
                    radius=~Size, color="red", 
                    fillOpacity=0.75) 
```


In the information that pops out of the marker, you can put a bit more information that may be helpful. Here I estimate some diversity measures (H<sub>O</sub>, H<sub>E</sub>, and A<sub>E</sub>).

```{r}
x <- genetic_diversity(arapat,stratum = "Population",mode="Ho")
x <- x[ x$Locus == "LTRS",]
coords <- merge( coords, x[,c(1,3)])
x <- genetic_diversity(arapat,stratum = "Population",mode="He")
x <- x[ x$Locus == "LTRS",]
coords <- merge( coords, x[,c(1,3)])
x <- genetic_diversity(arapat,stratum = "Population",mode="Ae")
x <- x[ x$Locus == "LTRS",]
coords <- merge( coords, x[,c(1,3)])
```

Make these data into a table format in html (ok it is a bit ugly but it is reasonable.)

```{r}
coords$label <- paste("<h2>",coords$Stratum,"</h2><table><tr><th>Parameter</th><th>Value</th></tr><tr><td>H<sub>O</sub></td><td>", format(coords$Ho,digits = 3),"</td></tr><tr><td>H<sub>E</sub></td><td>",format(coords$He, digits=3), "</td></tr><tr><td>A<sub>E</sub></td><td>",format(coords$Ae,digits=3),"</td></tr></table>",sep="")

# plot it
leaflet( data=coords ) %>%  
  addTiles() %>% 
  addCircleMarkers( ~Longitude, ~Latitude, 
                    popup=~label, 
                    radius=~Size, 
                    color="red", fillOpacity=0.75) 
```

